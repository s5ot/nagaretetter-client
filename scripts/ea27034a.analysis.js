"use strict";angular.module("nagaretetter").directive("whenScrolled",["$window",function(a){return{scope:{loadMore:"="},link:function(b,c){var d=c[c.length-1];angular.element(a).bind("scroll",function(){d.offsetTop+d.offsetHeight<document.documentElement.scrollTop+window.innerHeight&&b.loadMore()})}}}]),angular.module("nagaretetter").directive("twitterButton",["$timeout","YouTube",function(a,b){return{link:function(a,c,d){c.bind("$destroy",function(){var a=angular.element("#twitter-wjs");a.remove()});var e=d.text.split(" - "),f=b.query({title:e[0],artist:e[1]});f.then(function(a){var b="https://www.youtube.com/watch?v="+a;twttr.widgets.createShareButton(d.url,c[0],function(){},{count:"none",text:d.text+" "+b,hashtags:d.hashtags})})}}}]),angular.module("nagaretetter").service("YouTube",["$window","$http","$q",function(a,b,c){return{ready:!1,player:null,currentVideoId:null,query:function(a){var d=c.defer(),e=a.title+" "+a.artist;return b.jsonp("https:///www.googleapis.com/youtube/v3/search",{params:{q:e+" -みた -コピ -カラオケ -ピアノ",maxResults:1,callback:"JSON_CALLBACK",part:"snippet",type:"video",videoDefinition:"high",videoEmbeddable:!0,chart:"mostPopular",key:"AIzaSyAed5y3Syl_LLEDE9L5H9z20ridgfib5c0"}}).success(function(a){if(a.items[0]){var b=a.items[0].id.videoId;d.resolve(b)}else d.reject()}).error(function(){}),d.promise},play:function(a,b){var d=(c.defer(),this),e=this.query(a);e.then(function(a){d.ready?(d.player.clearVideo(),d.player.loadVideoById(a)):(d.player=new YT.Player("player",{height:"400",width:"600",videoId:a,playerVars:{autoplay:1,rel:0},events:{onStateChange:function(a){a.data==YT.PlayerState.ENDED&&b()}}}),d.ready=!0)},function(){b()})}}}]),angular.module("nagaretetter").service("PlayList",function(){this.list=[],this.index=0,this.ready=!1,this.add=function(a){this.list.push(a)},this.current_track=function(){return this.ready?this.list[this.index]:void 0},this.set_songs=function(a){this.list=a},this.next=function(a){return a||"undefined"!=typeof a?this.index=a:this.ready?this.index+1>=this.list.length?this.index=0:this.index++:this.index=0,this.ready=!0,this.list[this.index]},this.clear=function(){this.list=[],this.ready=!1},this.hasImage=function(a){return this.list[a].medium_image.length>0}}),angular.module("nagaretetter").directive("aboutPopover",function(){return{link:function(a,b){b.popover().on("click",function(a){a.preventDefault()})}}}),angular.module("nagaretetter").factory("Songs",["$resource",function(a){return a("http://nagaretetter-server.herokuapp.com/songs.json",{page:"nextPage"},{query:{method:"GET",isArray:!1}})}]),angular.module("d3",[]).factory("d3Service",["$document","$q","$rootScope",function(a,b,c){function d(){c.$apply(function(){e.resolve(window.d3)})}var e=b.defer(),f=a[0].createElement("script");f.type="text/javascript",f.async=!0,f.src="http://d3js.org/d3.v3.min.js",f.onreadystatechange=function(){"complete"===this.readyState&&d()},f.onload=d;var g=a[0].getElementsByTagName("body")[0];return g.appendChild(f),{d3:function(){return e.promise}}}]),angular.module("nagaretetter").directive("rankingChart",["d3Service",function(a){return{link:function(b,c){a.d3().then(function(a){a.json("http://nagaretetter-server.herokuapp.com/songs/ranking.json",function(b,d){var e=1e3,f=400,g=d.ranking,h=g.map(function(a){return a.title}),i=g.map(function(a){return a.total}),j=a.select(c[0]).append("svg").attr("width",e).attr("height",f),k=j.append("g").attr("transform","translate(40, 20)");k.append("g").attr("class","x axis").attr("transform","translate(0, 150)"),k.append("g").attr("class","y axis");var l=a.scale.ordinal().rangeRoundBands([0,e-100],.1).domain(h),m=a.scale.linear().range([150,0]).domain([0,a.max(i)]),n=k.selectAll(".bar").data(g);n.enter().append("rect"),n.exit().remove(),n.attr("class","bar").attr("width",l.rangeBand()).attr("height",function(a){return 150-m(a.total)}).attr("x",function(a){return l(a.title)}).attr("y",function(a){return m(a.total)}).attr({"data-container":"body","data-toggle":"popover","data-placement":"right"}).attr("data-content",function(a){return a.title+" / "+a.artist}).attr("data-title",function(a,b){return b+1+"位 : "+a.total+"回ナガレテッター"});var o=a.svg.axis().scale(l).orient("bottom"),p=a.svg.axis().scale(m).orient("left").tickFormat(a.format(".0"));a.select(".x.axis").call(o).selectAll("text").style("text-anchor","end").attr("dx","-.8em").attr("dy",".15em").attr("transform",function(){return"rotate(-65)"}),a.select(".y.axis").call(p),$(".bar").popover({trigger:"hover"}),$(".loading").hide()})},function(){console.log("error")})}}}]);