"use strict";angular.module("nagaretetter",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/analysis",{templateUrl:"views/analysis.html",controller:"AnalysisCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("nagaretetter").run(function(){var a=document.createElement("script");a.src="http://www.youtube.com/iframe_api";var b=document.getElementsByTagName("script")[0];b.parentNode.insertBefore(a,b),$("a[href=#about]").popover().on("click",function(a){a.preventDefault()})}).service("YouTube",["$window","$http","$q",function(a,b,c){this.ready=!1,this.player=null,this.currentVideoId=null,this.query=function(a){var d=c.defer(),e=a.title+" "+a.artist;return b.jsonp("http://gdata.youtube.com/feeds/api/videos",{params:{q:e+" -みた -コピ -カラオケ -ピアノ","max-results":2,format:5,alt:"json-in-script",callback:"JSON_CALLBACK"}}).success(function(a){if(a.feed.entry){a.feed.entry.sort(function(a,b){return b.favoriteCount-a.favoriteCount});var b=a.feed.entry[0].id.$t,c=b.match(/^.+\/(.+?)$/)[1];d.resolve(c)}else d.reject()}).error(function(){}),d.promise},this.play=function(a,b){var d=(c.defer(),this),e=this.query(a);e.then(function(a){d.ready?(d.player.clearVideo(),d.player.loadVideoById(a)):(d.player=new YT.Player("player",{height:"400",width:"600",videoId:a,playerVars:{autoplay:1,rel:0},events:{onStateChange:function(a){a.data==YT.PlayerState.ENDED&&b()}}}),d.ready=!0)},function(){b()})}}]).service("PlayList",function(){this.list=[],this.index=0,this.ready=!1,this.add=function(a){this.list.push(a)},this.current_track=function(){return this.ready?this.list[this.index]:void 0},this.set_songs=function(a){this.list=a},this.next=function(a){return a||"undefined"!=typeof a?this.index=a:this.ready?this.index+1>=this.list.length?this.index=0:this.index++:this.index=0,this.ready=!0,this.list[this.index]},this.clear=function(){this.list=[],this.ready=!1},this.hasImage=function(a){return this.list[a].medium_image.length>0}}).controller("MainCtrl",["$scope","$http","YouTube","PlayList","$rootScope",function(a,b,c,d,e){var f="http://nagaretetter-server.herokuapp.com/songs.json";a.songs=[],a.nextPage=1,e.targetUrl="/#/analysis",e.targetLinkName="Analysis",a.loadMore=function(){console.log("loadMore"),a.loading=!0,b.get(f,{params:{page:a.nextPage}}).success(function(b){a.nextPage!==parseInt(b.page)+1&&(a.songs=a.songs.concat(b.songs),d.set_songs(a.songs),a.nextPage=parseInt(b.page)+1,a.loading=!1)}).error(function(){console.log("error"),a.loading=!1})},a.isLoading=function(){return a.loading},a.play=function(b){c.play(d.next(b),a.play)},a.isActive=function(a){return d.ready&&d.index===a},a.hasImage=function(a){return d.hasImage(a)},a.songImage=function(b){var c=a.songs[b].medium_image;return 0===c.length?"images/yeoman.png":c},c.ready=!1,a.loadMore()}]).directive("whenScrolled",["$window",function(a){return function(b,c,d){var e=c[c.length-1];angular.element(a).bind("scroll",function(){e.offsetTop+e.offsetHeight<document.documentElement.scrollTop+window.innerHeight&&b.$apply(d.whenScrolled)})}}]).directive("twitter",["$timeout","YouTube",function(a,b){return{link:function(a,c,d){var e=d.text.split(" - "),f=b.query({title:e[0],artist:e[1]});f.then(function(a){var b="https://www.youtube.com/watch?v="+a;twttr.widgets.createShareButton(d.url,c[0],function(){},{count:"none",text:d.text+" "+b,hashtags:d.hashtags})})}}}]),angular.module("nagaretetter").controller("AnalysisCtrl",["$scope","$rootScope",function(a,b){console.log(b),b.targetUrl="/",b.targetLinkName="Main"}]);